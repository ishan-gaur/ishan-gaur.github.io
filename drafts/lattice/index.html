<h1>Defining the Generative Modeling Problem for Discrete Masking Models</h1>
<p>This is a blog post about generative models that are essentially time-inhomogenous markov chains. [^1] These include any-order autoregressive models (AO-ARM), discrete diffusion models (DDM), and discrete flow-matching models (DFM). Here we will focus on models that are used to define markov chains over the space of masked sequences. [^2] We will additionally assume that the simulation process is defined to terminate in some way (but perhaps in an unbounded number of steps [^3,^4]), where the distribution over end-states is somehow useful for generative modeling.</p>
<h2>Toy Problem</h2>
<p>Even though these models can operate in continuous or discrete time, we can often map them to a discrete time markov chain.[^6] What then becomes interesting is looking at the geometry[^5] of the underlying states and the resulting transition probability distributions. Consider the following space, which shows all the valid transitions for an unmasking model operating on a length-2 binary string.</p>
<p><picture><source type="image/webp" srcset="/drafts/lattice/4nR6qIpM3H-1275.webp 1275w"><img src="/drafts/lattice/4nR6qIpM3H-1275.jpeg" alt="baselattice" width="1275" height="1114"></picture></p>
<!-- ![baselattice](../img/base_lattice.svg) -->
<p>Now let's say that we are trying to train a generative model over this space. Let's say we want it to produce sequences where the second position is always 1. This means it should output &quot;0, 1&quot; or &quot;1, 1&quot; and not &quot;0, 0&quot; or &quot;1, 0&quot;. What should be the resulting transition probability distribution? Because there are so many edges, we can imagine two possibilities, one where each path to an output node has the same probability as any other, and another where the probability concentrates as much as possible.</p>
<p><picture><source type="image/webp" srcset="/drafts/lattice/UV5WTXya4T-1477.webp 1477w"><img src="/drafts/lattice/UV5WTXya4T-1477.jpeg" alt="balancedpaths" width="1477" height="1317"></picture>
<picture><source type="image/webp" srcset="/drafts/lattice/I-TQ4-VizA-1477.webp 1477w"><img src="/drafts/lattice/I-TQ4-VizA-1477.jpeg" alt="concentrated" width="1477" height="1317"></picture></p>
<!-- ![balancedpaths](../img/balanced_paths.svg) -->
<!-- ![concentrated](../img/concentrated_paths.svg) -->
<p>Both have the same distribution over the unmasked positions but totally different distributions over the intermediate states. We can also imagine that there is a full spectrum of solutions interpolating between these two as well. [^9]</p>
<h2>Design Decisions for a Generative Model</h2>
<p>Note that these two solutions both have different properties. Concentrating the paths might be useful if we assume a trembling hand model or some other perturbation of the transition distribution (e.g. guidance). Having the paths concentrate would means that it is hard for the guidance model to impact the rates enough to make the generative model start exploring an unfeasible sequence space. Another way to think about this is that we use softmaxes in practice so certain paths are never completely eliminated. In such a case, do we want to allow ourselves to be &quot;mode-covering&quot; and potentially err on the side of sampling things that are wrong, or do we want to push the model towards being more &quot;mode-seeking&quot; even if it means we lose some</p>
<p>There are also other design decisions. For example, the &quot;?&quot; symbols indicate an edge that would never be trained with standard diffusion/flow-matching training. Since the probability of observing the source states for those edges (&quot;_0&quot;) is zero and all final states descended from that state (&quot;00&quot;, and &quot;10&quot;) also have probability zero, the conditional probability of $P(<code>00&quot; | </code>_0&quot;)$ or $P(<code>00&quot; | </code>_0&quot;)$ is undefined. For example, if we have some amount of epistemic uncertainty, and there is a possibility we would discover a small probability $p$ of sampling $<code>00&quot;$ form the data, it might be a good idea to make the &quot;?&quot; both $0.5$. That way, as soon as I see $</code>00&quot;$ in the data, I will get gradients to reduce $P(<code>10&quot;|</code>_0&quot;)$ and to increase $P(<code>\_0&quot;|</code>__&quot;)$. [^7] However, we can see in the case of concentrated paths that I actually do have information about the endpoints else where in the transition graph and that $P(<code>01&quot; | </code>0_&quot;)$ should probably be 1, just like in the balanced path case.</p>
<p>Finally, the distribution of the empirical distribution might be induced by some sort of time evolution of an initial set of samples according to some underlying reward function. [^8] How do we have the model generalize the underlying reward if its training tries to make it match the empirical distribution?</p>
<p>uniformity is good for being able to pick paths arbitrarily</p>
<ul>
<li>also seems to be better at adapting to later learning signal
concentration is good for trembling hand problem</li>
<li>so long as you actually train on everything so the question marks go away
<ul>
<li>in this sense the uniformity is a good thing because arbitrary paths means you need to get the conditionals right everywhere</li>
</ul>
</li>
<li>this could be nice for guidance because the number of paths is limited</li>
<li>constraints are also set first, but that is why you lose the ability to pick paths arbitrarily</li>
</ul>
<p>Summarizing the above section we see the following design choices:</p>
<ol>
<li>Should the distribution be mode-covering or mode-seeking under perturbations?</li>
<li>Should the order of denoising be decided by the model or available to select at random?</li>
<li>For unobserved intermediate states, should we direct those towards known observed states or stay agnostic until we get direct information about the state?</li>
<li>How do we train the model to generalize past the currently available data, when what we really care about is eventually getting samples according to the generating reward function?</li>
</ol>
<p>Current models must deal with any denoising order, but empirically show better results for some decoding order over others. [^10] We also know that they factor their unmasking distribution by position. In doing so, there is again both a balancing and a concentrated solution.</p>
<p><picture><source type="image/webp" srcset="/drafts/lattice/3a_VLJFRPm-1477.webp 1477w"><img src="/drafts/lattice/3a_VLJFRPm-1477.jpeg" alt="flowsolution" width="1477" height="1317"></picture></p>
<!-- ![flowsolution](../img/factored_balance.svg) -->
<p>Interestingly, for paths that start with unmasking the first position, you may notice that the probabilities are proportional to the corresponding conditional distributions for the balanced solution, but for paths that mutate the second position, the probabilities look like the concentrated solution. Still, the probabilities of each path are uniform.</p>
<h2>Fitting the Empirical vs Data Distribution</h2>
<p>In continuous state spaces, it is generally known (for images and proteins) that there are substantial problems with mode collapse when sampling unconditionally. <strong>Is this the case with discrete models?</strong></p>
<p>Let's take a step back and think about how a model might learn this ideal distribution. Our hope generally is that, because some areas of sequence space--protein or language--are more densely populated, and our models aren't large enough to fit the whole combinatorial space of transitions well, that they will have to <em>smooth</em> out the probabilities over this net bundle (see below in the next section). As a result they will approximate the generating distribution well.</p>
<p>In the continuous case, we have some theoretical lines of work that confirm the mode collapse findings earlier. They find that to a certain point, the model gets a better and better approximation of the data distribution.</p>
<p>In the discrete case, we might not be as sure. When training the models, we pick an unmasked string, a number of positions masked, and the set of masked positions all uniformly at random. This means that the from the beginning, if there is some extra reward weighting on top of our empirical distribution, we are definitely not learning it--at least not by construction. Let's continue on, however, assuming that we somehow sample the end sequence according to this reward.</p>
<p><picture><source type="image/webp" srcset="/drafts/lattice/vcWHO9bgMp-1596.webp 1596w"><img src="/drafts/lattice/vcWHO9bgMp-1596.jpeg" alt="mask_states" width="1596" height="1479"></picture></p>
<!-- ![mask_states](../img/mask_state_probs.svg) -->
<p>Once we choose a masked sequence, because of the assumption that the distribution of transitions factors into the product of the position-wise marginals all weighted equally, we can train each of them individually with cross entropy. However, we only give them signal from the final sequence. For example, if we sample &quot;11&quot; and fully masked, then the model gets signal to set &quot;_1&quot; and &quot;1_&quot; to 1/4 and &quot;0_&quot; and &quot;_0&quot; to 0. When we sample &quot;01&quot;, we similarly set &quot;_0&quot; and &quot;_1&quot; to 1/4 and &quot;1_&quot; and &quot;0_&quot; to 0.</p>
<p>Then consider the two incoming edges to &quot;01&quot;. It shares the parent &quot;_1&quot; with 11, which means &quot;_1&quot; will get training signal $3$ times as often as &quot;0_&quot;. Maybe this is okay because we want to learn a pretty simple distribution for that node, but in some sense errors there matter more. [^11] More directly, what does this kind of asymmetry mean about our estimate of the likelihood of the resulting sequence?</p>
<p>What can we say about this formally?
We can show that the variance in the estimate of $p(x|\sigma)$, the variance in the estimate of the likelihood of a sequence as we use different decoding orders (which is $0$ for the perfectly path-balanced model) is directly related to the probability of the sequence to begin with.
Basically the equation shows that the variance is only zero when the model learns to predict the actual prob with all paths, which is not that interesting???</p>
<h2>Extra Credit: Mathematical Structure of This Object</h2>
<p>Note that if you just look at the four corners of this diagram that are the denoised positions, they form the vertices of a square. Then, note that single masked positions that constitute the common string formed when masking the same position on two adjacent vertices lies on their edge. Finally the all masked token lies on the face of the square itself. This extends to arbitrary dimension. For strings of length 3, the single masks are edges, double masks are faces, and all masked constitutes the volume of the cube. I think this has something to do with the face maps, ie when you unmask a position, you drop a class of alternative points from the simplex. But there is more too--this is the product of D, S-simplices and unmasking corresponds to using a face map to drop all but one vertices on the simplex for that position.</p>
<p>For the masked sequences of a fixed string, we can see that this is isomorphic to the powerset where the elements in the set correspond to the masked positions, ie the empty set is the unmasked string. Because of this, we can see that the set of masked sequences forms a partially ordered set (poset) where we say one element precedes the other if the latter can be obtained by masking positions in the former (ie inclusion under the corresponding power sets).</p>
<p>Adding back all the strings in the language, eventually I think this will end up being a <a href="https://arxiv.org/pdf/0707.0240"><em>net bundle</em></a>. There may be further connections as well that are appropriate based on the nature of the following question:</p>
<p><strong>Extra Extra Credit: How do we think about the fact that the model is learnin ghte transitions across sequences of many lengths? What can the structure of attention tell us about the connections between the bundles.</strong>
The positional embedding changes non-homogenously around the inserted/deleted token (ie things to the right increase/decrease). The attention value at a layer only changes if the softmax changes, but it will change for a lot of the structure.</p>
<p><strong>Maybe we can use the anthropic interp tools for an empirical study?</strong></p>
<p>[^1] Can also think of them as general denoisers but we use them to execute random runs of a markov chain. LLM people think of learning as compression. Sampling is optimization.</p>
<p>[^2] There are also uniform noise processes and other noise distributions. Sometimes, the distribution is sampled by training a model such that the stationary distribution of the markov chain approximates samples from the desired distribution. For example, this is the case for models that take a random string and &quot;denoise&quot; it to look more like something that came from the data.</p>
<p>[^3] In the uniform case, you are not guaranteed to have a set number of transitions.</p>
<p>[^4] You can also have processes that jump around the denoised time or, like diffusion models, the limiting noise distribution is not actually started with because at lives at $t=\infty$.</p>
<p>[^5] I think this can be called a net bundle where you have a <em>fiber</em> which is a boolean lattice for each possible string.</p>
<p>[^6] When is this the case?</p>
<p>[^7] Note for the model, each data-point has equal probability and every other point (in terms of the loss) is $0$.</p>
<p>[^8] This actual protein evolution over time, changes in images over the course of the last 200 years, or having a LLM generalize beyond a known mathematical result.</p>
<p>[^9] Are there other things that would pop up if I looked at length-3 strings?</p>
<p>[^10] Path planning thing and DLM experiments with AR decoding. <strong>Also image models are known to suffer from mode collapse.</strong></p>
<p>[^11] One thing you might want to do is to hash the masked sequences or even substrings and then have some probability of rejecting a training sample if the</p>
